#### Цель работы
Целью данной практической работы является освоение алгоритма фильтра Калмана для задачи локализации мобильной платформы в двумерном пространстве путём объединения (fusion) данных от различных датчиков с разной частотой обновления и разной точностью.

#### Задачи работы
1. Подготовка данных:
- Загрузить и проанализировать CSV-файлы
- Построить графики траекторий, угловой и линейной скоростей для одометрии и IMU
- Написать в отчете частоту обновления каждого датчика, наличие выбросов, пропусков данных, NaN-значений. 

2. Реализация фильтра Калмана:
- Разработать модель состояния и движения мобильного робота
- Реализовать шаги предсказания и коррекции с учётом асинхронных измерений
- Настроить ковариационные матрицы Q- шум процесса и R- шум измерений

3. Анализ результатов:
- Сравнить траекторию, полученную фильтром Калмана, с ground truth
- Вычислить метрики ошибки (RMSE) для положения и ориентации
- Ответить на поставленные вопросы

#### Описание датасета
В работе используется набор данных, экспортированных из симулятора Gazebo, который содержит записи сенсоров мобильного робота с дифференциальным приводом.

Структура данных:

- `diff_drive_controller/odom.csv` — одометрия от дифференциального привода (оценка положения и скоростей на основе энкодеров колёс). Частота обновления: 50 Гц.
- `gps/fix.csv` — данные GPS-приёмника с абсолютными координатами в формате широта/долгота. Частота обновления: 6.7 Гц.

- `imu/data.csv` — данные инерциального измерительного модуля (IMU), включая ориентацию (кватернион), угловые скорости и линейные ускорения. Частота обновления: 187 Гц.

- `gz_odometry (ground_truth)/gz_odometry.csv` — истинная траектория робота из симулятора (ground truth).,

- `odometry/gps.csv` — дополнительные данные GPS-одометрии.

- `gnss/velocity.csv` — данные о скорости от GNSS-приёмника.

___

#### Теоретическая часть

#### Описание выбранного вектора состояния

Для описания состояния мобильного робота с дифференциальным приводом в двумерном пространстве выбран вектор состояния:

$$
\mathbf{x} = \begin{bmatrix}
x \\
y \\
\theta \\
v \\
\omega
\end{bmatrix}
$$

где:
- **\(x, y\)** — координаты робота в метрах в глобальной системе отсчета `odom`;
- **\(θ\)** — угол ориентации робота (yaw) в радианах;
- **\(v\)** — линейная скорость робота в направлении его продольной оси в м/с;
- **\(ω\)** — угловая скорость поворота робота вокруг вертикальной оси в рад/с.

Данный вектор состояния выбран как минимально необходимая для задачи локализации величина, позволяющая полностью описать положение и динамику движения робота на плоскости.

#### Модель движения
Для дискретного времени с шагом \($\Delta t$\) используется нелинейная модель движения, основанная на кинематике дифференциального привода:

$$
\begin{aligned}
x_{k} &= x_{k-1} + v_{k-1} \cos(\theta_{k-1}) \Delta t \\
y_{k} &= y_{k-1} + v_{k-1} \sin(\theta_{k-1}) \Delta t \\
\theta_{k} &= \theta_{k-1} + \omega_{k-1} \Delta t \\
v_{k} &= v_{k-1} \\
\omega_{k} &= \omega_{k-1}
\end{aligned}
$$

В векторно-матричной форме модель может быть записана как:

$$
\mathbf{x}_{k} = f(\mathbf{x}_{k-1}, \Delta t) + \mathbf{w}_{k}
$$

где **wₖ** — шум процесса, описывающий неучтенные факторы (проскальзывание колес, неточность модели и внешние возмущения). Шум предполагается нормально распределенным:

$$w_k \sim \mathcal{N}(0, Q)$$

Данная модель предполагает, что на интервале $\Delta t$ скорости $v$ и $\omega$ остаются постоянными. Модель является нелинейной из-за наличия тригонометрических функций $\cos(\theta)$ и $\sin(\theta)$, что требует использования расширенного фильтра Калмана (EKF) с линеаризацией (вычислением матрицы Якоби).

Матрица Якоби для данной модели имеет вид:

$$
F_j = \frac{\partial f}{\partial \mathbf{x}} = \begin{bmatrix}
1 & 0 & -v \sin(\theta) \Delta t & \cos(\theta) \Delta t & 0 \\
0 & 1 & v \cos(\theta) \Delta t & \sin(\theta) \Delta t & 0 \\
0 & 0 & 1 & 0 & \Delta t \\
0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 1
\end{bmatrix}
$$

#### Описание ковариаций Q и R

##### Матрица шума процесса Q

Матрица \(Q\) отражает степень неопределенности модели движения и настраивается экспериментально. В данной работе использована диагональная матрица, где каждый диагональный элемент соответствует дисперсии соответствующей компоненты состояния:

$$
Q = \text{diag}(\sigma_x^2, \sigma_y^2, \sigma_\theta^2, \sigma_v^2, \sigma_\omega^2)
$$

На основе анализа данных и рекомендаций из методички выбраны следующие значения:

- $\sigma_x = \sigma_y = 0.01$ м — небольшая неопределенность по положению, связанная с неточностью модели движения на каждом шаге;
- $\sigma_\theta = 0.01$ рад — неопределенность по углу;
- $\sigma_v = 0.05$ м/с — неопределенность по линейной скорости;
- $\sigma_\omega = 0.05$ рад/с — неопределенность по угловой скорости.
Таким образом:

$$
Q = \begin{bmatrix}
0.0001 & 0 & 0 & 0 & 0 \\
0 & 0.0001 & 0 & 0 & 0 \\
0 & 0 & 0.0001 & 0 & 0 \\
0 & 0 & 0 & 0.0025 & 0 \\
0 & 0 & 0 & 0 & 0.0025
\end{bmatrix}
$$

##### Матрицы шума измерений R

Матрицы \(R\) определяются точностью соответствующих датчиков и извлекаются из предоставленных данных (файлы ковариаций в CSV) либо задаются на основе значений из методички.

##### Для GPS (измерение положения x, y):

Из методички:

$$
R_{\text{gps}} = \begin{bmatrix}
0.09 & 0 \\
0 & 0.09
\end{bmatrix}
$$

что соответствует стандартному отклонению $\sigma = 0.3$ м по каждой координате. Матрица наблюдения для GPS:

$$
H_{\text{gps}} = \begin{bmatrix}
1 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0
\end{bmatrix}
$$

##### Для IMU измерение угла \($\theta$\):

Из методички:

$$
R_{\text{imu}} = \begin{bmatrix}
7.615 \times 10^{-5}
\end{bmatrix}
$$

что соответствует стандартному отклонению $\sigma_\theta \approx 0.0087$ рад ≈ 0.5°. Матрица наблюдения для IMU:

$$
H_{\text{imu}} = \begin{bmatrix}
0 & 0 & 1 & 0 & 0
\end{bmatrix}
$$

### Задание 1.
<img width="1489" height="490" alt="image" src="https://github.com/user-attachments/assets/90872010-3e3e-44db-bb5b-ae7efc68add0" />
<img width="1190" height="790" alt="image" src="https://github.com/user-attachments/assets/c564c7a5-815d-4e0e-8f97-096e0ad8e369" />

ОДОМЕТРИЯ:
  - Количество измерений: 6164
  - Средний интервал: 20.000 мс
  - Частота: 50.0 Гц
  - NaN значения: 0
  - Выбросы в интервалах: 0 из 6163 (0.00%)

IMU:
  - Количество измерений: 23692
  - Средний интервал: 5.175 мс
  - Частота: 193.2 Гц
  - NaN значения: 0
  - Выбросы в интервалах: 800 из 23691 (3.38%)

GPS:
  - Количество измерений: 1227
  - Средний интервал: 173.773 мс
  - Частота: 5.8 Гц
  - NaN значения: 1227
  - Выбросы в интервалах: 48 из 1226 (3.92%)

GROUND TRUTH:
  - Количество измерений: 6232
  - Средний интервал: 20.000 мс
  - Частота: 50.0 Гц
  - NaN значения: 0
  - Выбросы в интервалах: 0 из 6231 (0.00%)
  <img width="1389" height="789" alt="image" src="https://github.com/user-attachments/assets/7b8c3257-93a8-4ce7-937c-dd4279e4acaf" />
В результате выполнения первого задания были построены отдельные графики траекторий для:
- одометрии
- траектории только по gps
- траектории истинной по ground_truth
Также построены графики угловой скорости wx и линейной скорости vx во времени из одометрии и IMU.
В блоке анализа данных для отчета описаны частоты обновления каждого датчика. ВИдно, что для gps получено меньше всего значений, поскольку измерение gps обычно долгое и для получения информации о местоположении необходимо получить информацию с нескольких источников и синхронизировать ее.
Одометрия хорошо дрейфует со временем, особенно на поворотах и смене направления траектории. На линейных участках дрейфа не наблюдается.

### Задание 2.
  РЕЗУЛЬТАТЫ ФИЛЬТРАЦИИ

----------------------------------------------------------------------
Метод                RMSE (м)        Средняя ошибка      
-------------------------------------------------------
Одометрия            10.779          8.683               
EKF                  10.889          8.787               

Улучшение точности: -1.0%
<img width="772" height="530" alt="image" src="https://github.com/user-attachments/assets/cab3681e-aa65-49c3-b92f-8704b008475c" />

### Задание 3. 
<img width="989" height="790" alt="image" src="https://github.com/user-attachments/assets/3a2b0248-d902-4729-8913-64f235049d3f" />
RMSE X: 7.932 м
RMSE Y: 7.460 м
RMSE θ: 2.873 рад
<img width="1189" height="823" alt="image" src="https://github.com/user-attachments/assets/bd4bd7d4-0cc8-4bdb-919c-2d6c74a46463" />

----------------------------------------------------------------------
Метод                RMSE X (м)      RMSE Y (м)      RMSE θ (рад)   
----------------------------------------------------------------------
Только одометрия     7.782           7.458           2.370          
Только GPS           26.668          0.888           -              
Фильтр Калмана       7.932           7.460           2.873          


Улучшение относительно одометрии по X: -1.9%
Улучшение относительно одометрии по Y: -0.0%
Улучшение относительно одометрии по θ: -21.2%
ЗАДАНИЕ 5: АНАЛИЗ ЧУВСТВИТЕЛЬНОСТИ


--------------------------------------------------------------------------------
Конфигурация                   RMSE X (м)      RMSE Y (м)      RMSE θ (рад)   
--------------------------------------------------------------------------------
Базовый EKF                    7.932           7.460           2.873          
Q × 10                         7.937           7.459           2.858          
R_gps × 10                     7.918           7.462           2.874          

<img width="1489" height="490" alt="image" src="https://github.com/user-attachments/assets/5090a787-a329-44c1-9c63-7048010131f5" />





#### Для одометрии (используется как управляющий вход):
Одометрия не используется в матрице $R$, так как в данной реализации она применяется для предсказания (как источник скоростей $v$ и $\omega$), а не для коррекции. Ковариация одометрии ($\sigma \approx 3.2$ см) учитывается косвенно через матрицу $Q$ и через то, что одометрия не является абсолютным измерением.
